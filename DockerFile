# -------------------
# Stage 1: PHP + Composer + Node
# -------------------
FROM php:8.2-fpm

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git curl zip unzip nodejs npm libpng-dev libonig-dev libxml2-dev \
    && docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Install Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# Set working directory
WORKDIR /var/www

# Copy Laravel files
COPY . .

# Install Laravel dependencies
RUN composer install --no-dev --optimize-autoloader

# Install React + Bootstrap inside Laravel
WORKDIR /var/www
RUN npm install react react-dom react-router-dom bootstrap \
    && npm install && npm run build

# -------------------
# Stage 2: Nginx
# -------------------
FROM nginx:alpine

# Copy nginx config
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

WORKDIR /var/www

# Copy everything from PHP container (Laravel + React build)
COPY --from=0 /var/www /var/www

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
